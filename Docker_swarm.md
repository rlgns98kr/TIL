# 프로젝트

## 도커 스웜

### 개요

도커 분산환경에서 자원을 효율적으로 관리한다.



### 클러스터

- 코디네이터
  - 코디네이터란 각종 정보를 저장하고 동기화
- 매니저
  - 클러스터 내의 서버를 관리하고 제어
- 에이전트
  - 각 서버를 제어



### 주키퍼

- 분산환경 코디네이터



### 도커

- 도커 스웜
  - 도커 1.6 버전 이후부터 사용
- 도커 스웜 모드



### 도커 스웜 모드

- 매니저 노드
  - 워커를 관리하기 위한 도커 노드
  - 1개 이상 존재해야 하며, 운영환경에서는 여러개가 있어야 함
  - 절반 이상에 장애 시 복구를 위해 클러스터 중단
- 워커 노드
  - 실제 컨테이너가 생성되고 관리되는 도커 노드
- 생성 및 참여
  - 매니저에서 docker swarm init --advertise-addr 매니저IP
  - 워커에서 docker swarm join --token ~ 192.168.111.100:2377
  - ~(참여 비밀키)은 매니저에서 docker swarm join-token [worker or manager] 로 확인할 수 있다.
  - docker swarm leave -> 참여하고 있는 클러스터에서 떠난다.(워커의 경우 매니저에게는 Down 상태로 보임), (매니저의 경우 마지막 매니저가 떠난다면 클러스터가 해제된다)

- 관리
  - docker node ls -> 현재 클러스터 참여 노드들의 목록을 본다.
  - docker node rm 호스트네임 -> 호스트네임을 가진 노드가 제거된다.
  - docker node promote/demote 호스트네임 -> 호스트네임을 가진 노드가 매니저권한을 갖는다/잃는다
  - 매니저권한을 가진 노드들은 Leader와 동등한 권한을 갖는다. 심지어 Leader를 demote할 수도 있다. Leader를 demote하면 자신이 Leader가 된다.



### 서비스

- 같은 이미지로 생성된 컨테이너의 집합
- docker service ls
- docker service ps 서비스 이름 -> 자세히
- docker service rm 서비스 이름 -> 삭제
- 클러스터 안에서는 스웜이 서비스접속을 관리한다. 따라서 개별 노드가 컨테이너 실행 중이 아니더라도 컨테이너 실행 중인 노드에게 포워딩을 해준다. -> 라운드 로빈 방식으로 서비스 내에 접근할 컨테이너를 선택

- 2377, 7946, 4789 의 방화벽이 열려있어야 도커스웜을 이용한 서비스 활성화 가능
- 복제 모드 서비스
  - 정의한 리플리카의 개수만큼 컨테이너가 생성
- 글로벌 모드 서비스
  - 모든 노드에 컨테이너를 생성(--mode global 옵션으로 실행가능)

- 노드가 다운되면 다른 노드로 컨테이너 위임
- 컨테이너를 다운시켜도 재실행
- 롤링업데이트 지원 -> docker service update --image 이미지이름:버젼 서비스이름
- 롤백